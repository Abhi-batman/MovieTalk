<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Reviews</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100">
    <!-- Logged-in Navbar -->
    <nav
      id="loggedInNavbar"
      class="sticky top-0 z-50 w-full bg-white/80 backdrop-blur-md shadow-md transition-all duration-300"
    >
      <div
        class="max-w-7xl mx-auto flex justify-between items-center px-4 py-2"
      >
        <a href="#" class="flex items-center space-x-2">
          <img
            src="https://assets.aceternity.com/logo-dark.png"
            alt="logo"
            class="w-8 h-8"
          />
          <span class="font-bold text-black">MovieTalk</span>
        </a>

        <!-- Desktop Menu -->
        <div class="hidden lg:flex items-center space-x-4">
          <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
          <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200"
            >My Reviews</a
          >

          <!-- Profile Photo -->
          <div class="relative">
            <button
              id="profileButton"
              class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 focus:outline-none"
            >
              <img id="avatar"
                src="https://i.pravatar.cc/100?img=12"
                alt="Profile"
                class="w-full h-full object-cover"
              />
            </button>

            <!-- Dropdown Menu -->
            <div
              id="profileDropdown"
              class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg"
            >
              <a
                href="/profile.html"
                class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
                >Profile</a
              >
              <hr class="border-gray-200" />
              <a
                href="/logout"
                class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
                >Logout</a
              >
            </div>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="loggedInMobileMenuButton"
          class="lg:hidden px-3 py-2 rounded bg-gray-200"
        >
          ☰
        </button>
      </div>

      <!-- Mobile Menu -->
      <div
        id="loggedInMobileMenu"
        class="hidden flex-col px-4 py-2 space-y-2 bg-white shadow-md lg:hidden"
      >
        <a href="/" class="px-3 py-2 rounded hover:bg-gray-200">Home</a>
        <a href="/myreview.html" class="px-3 py-2 rounded hover:bg-gray-200"
          >My Reviews</a
        >
        <div
          class="flex items-center space-x-2 px-3 py-2 border-t border-gray-200 mt-2"
        >
          <img
            src="https://i.pravatar.cc/100?img=12"
            alt="Profile"
            class="w-10 h-10 rounded-full object-cover"
          />
          <span class="text-gray-700 font-semibold">John Doe</span>
        </div>
        <a href="/profile.html" class="px-3 py-2 rounded hover:bg-gray-200"
          >Profile</a
        >
        <a href="/logout" class="px-3 py-2 rounded hover:bg-gray-200">Logout</a>
      </div>
    </nav>

    <script>
      // Mobile menu toggle
      const button = document.getElementById("loggedInMobileMenuButton");
      const menu = document.getElementById("loggedInMobileMenu");
      button.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

      // Profile dropdown toggle
      const profileButton = document.getElementById("profileButton");
      const profileDropdown = document.getElementById("profileDropdown");
      profileButton.addEventListener("click", () => {
        profileDropdown.classList.toggle("hidden");
      });

      // Close dropdown if clicked outside
      document.addEventListener("click", (e) => {
        if (
          !profileButton.contains(e.target) &&
          !profileDropdown.contains(e.target)
        ) {
          profileDropdown.classList.add("hidden");
        }
      });
    </script>

    <!-- Profile Section -->
    <section
      class="bg-white shadow-md rounded-lg max-w-3xl mx-auto mt-10 p-6 flex flex-col items-center"
    >
      <img id='avatar'
        src="https://images.unsplash.com/photo-1603415526960-f7e0328a23b3?ixlib=rb-4.0.3&auto=format&fit=crop&w=120&h=120&q=80"
        alt="User Profile"
        class="w-28 h-28 rounded-full border-4 border-indigo-500 mb-4 object-cover"
      />
      <h1 id="headfullName" class="text-2xl font-semibold">John Doe</h1>
      <p id="headUsername" class="text-gray-500">@johndoe</p>
      <p class="mt-2 text-gray-700">
        Total Reviews: <span id="totalReviews" class="font-semibold">12</span>
      </p>

      <!-- Create Review Button -->
      <a
        href="/createreview.html"
        class="mt-4 px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition"
      >
        + Create Review
      </a>
    </section>

    <!-- Reviews Section -->
    <section id="cards" class="max-w-3xl mx-auto mt-8 space-y-6">
      <!-- Single Review Card -->
     


      
    
      
    </section>

<script>
  const headUsername=document.getElementById('headUsername')
  const headfullName=document.getElementById('headfullName')
  const headAvatar=document.getElementById('avatar')
  const totalReviews=document.getElementById('totalReviews')
const cards=document.getElementById('cards')
  document.addEventListener('DOMContentLoaded',async()=>{
   try {
    const res = await fetch("https://fuzzy-goggles-g6vxrj9xwpg3v97j-5000.app.github.dev/api/v1/users/getProfile", {
      method: "GET",
      credentials: "include"
    });
    const data = await res.json();
    console.log('getprofile ', data)
   



    if (res.ok && data.data) {
      const user = data.data;
      headUsername.innerText = "@" + user.username;
      headfullName.innerText = user.fullName;
      
      headAvatar.src = user.avatar;


    
  
    const responsePosts=await fetch(`https://fuzzy-goggles-g6vxrj9xwpg3v97j-5000.app.github.dev/api/v1/users/getPosts?username=${user.username}`,{
      method:'GET',
      credentials:'include',
       
   
    })
    
    const result=await responsePosts.json()
    console.log(result)
    totalReviews.innerText=result.data[0].postCount
    

    if(responsePosts.ok && result.data){
      result.data[0].posts.forEach((element,index) => {
        const card=document.createElement('div')
        card.className='bg-white shadow-md rounded-lg overflow-hidden'
        card.id='review-1'
        card.innerHTML=`
<img 
    src="${element.image}"
    alt="Movie Image"
    class="w-full h-48 object-cover"
  />

  <!-- Review Content -->
  <div class="p-4">
    <h2 class="text-xl font-semibold mb-2">${element.title}</h2>

    <!-- Review Text -->
    <p id="review-text-${index}" class="text-gray-700 mb-3">
     ${element.description}
    </p>

    <!-- Editable Textarea (hidden by default) -->
    <textarea
      id="edit-box-${index}"
      class="hidden w-full border border-gray-300 rounded-md p-2 mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      rows="3"
    ></textarea>

    <!-- Submit Update Button (hidden by default) -->
    <button
      id="submit-update-${index}"
      class="hidden bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"
    >
      Submit
    </button>

    <!-- Rating -->
    <div class="flex items-center justify-between">
      <span class="text-yellow-500 font-semibold">★ ${element.rating}</span>

      <!-- Update and Delete Buttons -->
      <div class="space-x-2">
        <button
          id="update-btn-${index}"
          class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
        >
          Update
        </button>
        <button
          id="delete-btn-${index}"
          class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

        `

        cards.appendChild(card)

        const updateBtn=document.getElementById(`update-btn-${index}`)
        const deleteBtn=document.getElementById(`delete-btn-${index}`)
        const editBox=document.getElementById(`edit-box-${index}`)
        const submitUpdate=document.getElementById(`submit-update-${index}`)
        const reviewText=document.getElementById(`review-text-${index}`)

      


   
    
    updateBtn.addEventListener('click', () => {
      editBox.value = reviewText.innerText.trim();
      reviewText.classList.add('hidden');
      editBox.classList.remove('hidden');
      submitUpdate.classList.remove('hidden');
    });

  
    submitUpdate.addEventListener('click', async () => {
      const updatedText = editBox.value.trim();
      if (!updatedText) {
        alert('Description cannot be empty!');
        return;}

if(updatedText===reviewText.value){
  throw new Error('No change was done in description')


      }

      const description={

        description:updatedText
      }

      try {
        const res=await fetch(`https://fuzzy-goggles-g6vxrj9xwpg3v97j-5000.app.github.dev/api/v1/post/updatePost/${element._id}`,{
          method:'PATCH',
          credentials:'include',
          headers: {
    'Content-Type': 'application/json'
  },
          body:JSON.stringify(description),
          

        })
        const data=await res.json()

      reviewText.innerText = updatedText;
      reviewText.classList.remove('hidden');
      editBox.classList.add('hidden');
      submitUpdate.classList.add('hidden');
        if(res.ok && data){
          alert('Updated successfully')
        }else{
          alert('Couldnt update')
        }
      } catch (error) {
        console.log('Couldnt update description ',error)
      
    }
      

    
    });

    
    deleteBtn.addEventListener('click', async () => {
  if (confirm('Are you sure you want to delete this review?')) {
    try {
      const res = await fetch(`https://fuzzy-goggles-g6vxrj9xwpg3v97j-5000.app.github.dev/api/v1/post/deletePost/${element._id}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      const data = await res.json();

      if (res.ok && data) {
        card.remove();
        alert('Review deleted successfully');
      } else {
        alert('Could not delete review');
      }
    } catch (error) {
      console.error('Error deleting review', error);
      alert('Error deleting review');
    }
  }
});

  

      });
    }


      
     else {
      alert("Error fetching profile or posts");
    }}
  } catch (err) {
    console.error("Error fetching profile", err);
  }




})


</script>
  </body>
</html>
